version: '3.8'

# RonDB-Docker version: 0.2-SNAPSHOT
services:

    mgmd_1:
      image: rondb-standalone:21.04.10
      container_name: mgmd_1
      command: ["ndb_mgmd", "--ndb-nodeid=65", "--initial"]
      deploy:
        resources:
          limits:
            cpus: '0.2'
            memory: 50M
          reservations:
            memory: 20M
      volumes:
      - type: bind
        source: <path-to-repo>/autogenerated_files/v21049_m1_g1_r2_my1_api1/config.ini
        target: /srv/hops/mysql-cluster/config.ini
      - type: bind
        source: <path-to-repo>/autogenerated_files/v21049_m1_g1_r2_my1_api1/volumes/dataDir_mgmd_1
        target: /srv/hops/mysql-cluster/mgmd
      - type: bind
        source: <path-to-repo>/autogenerated_files/v21049_m1_g1_r2_my1_api1/volumes/logDir_mgmd_1
        target: /srv/hops/mysql-cluster/log
      environment:
      - HOST_GROUP_ID=20

    ndbd_1:
      image: rondb-standalone:21.04.10
      container_name: ndbd_1
      command: ["ndbmtd", "--ndb-nodeid=1", "--initial", "--ndb-connectstring=mgmd_1:1186"]
      deploy:
        resources:
          limits:
            cpus: '2'
            memory: 3000M
          reservations:
            memory: 2000M
      volumes:
      - type: bind
        source: <path-to-repo>/autogenerated_files/v21049_m1_g1_r2_my1_api1/volumes/dataDir_ndbd_1
        target: /srv/hops/mysql-cluster/ndb_data
      - type: bind
        source: <path-to-repo>/autogenerated_files/v21049_m1_g1_r2_my1_api1/volumes/logDir_ndbd_1
        target: /srv/hops/mysql-cluster/log
      environment:
      - HOST_GROUP_ID=20

    ndbd_2:
      image: rondb-standalone:21.04.10
      container_name: ndbd_2
      command: ["ndbmtd", "--ndb-nodeid=2", "--initial", "--ndb-connectstring=mgmd_1:1186"]
      deploy:
        resources:
          limits:
            cpus: '2'
            memory: 3000M
          reservations:
            memory: 2000M
      volumes:
      - type: bind
        source: <path-to-repo>/autogenerated_files/v21049_m1_g1_r2_my1_api1/volumes/dataDir_ndbd_2
        target: /srv/hops/mysql-cluster/ndb_data
      - type: bind
        source: <path-to-repo>/autogenerated_files/v21049_m1_g1_r2_my1_api1/volumes/logDir_ndbd_2
        target: /srv/hops/mysql-cluster/log
      environment:
      - HOST_GROUP_ID=20

    mysqld_1:
      image: rondb-standalone:21.04.10
      container_name: mysqld_1
      command: ["mysqld"]
      cap_add:
        - SYS_NICE
      deploy:
        resources:
          limits:
            cpus: '2'
            memory: 1400M
          reservations:
            memory: 650M
      volumes:
      - type: bind
        source: <path-to-repo>/autogenerated_files/v21049_m1_g1_r2_my1_api1/my.cnf
        target: /srv/hops/mysql-cluster/my.cnf
      - type: bind
        source: <path-to-repo>/autogenerated_files/v21049_m1_g1_r2_my1_api1/volumes/dataDir_mysqld_1
        target: /srv/hops/mysql-cluster/mysql
      - type: bind
        source: <path-to-repo>/autogenerated_files/v21049_m1_g1_r2_my1_api1/volumes/mysqlFilesDir_mysqld_1
        target: /srv/hops/mysql-cluster/mysql-files
      environment:
      - HOST_GROUP_ID=20
      - MYSQL_ALLOW_EMPTY_PASSWORD=true
      - MYSQL_USER=mysql
      - MYSQL_PASSWORD=Abc123?e
      - MYSQL_SETUP_APP=1

    api_1:
      image: rondb-standalone:21.04.10
      container_name: api_1
      command: >
          bash -c "ndb_waiter --ndb-connectstring=mgmd_1:1186 &&
                    sleep 35 &&
                    bench_run.sh --verbose --default-directory /home/mysql/benchmarks/sysbench_single "
      deploy:
        resources:
          limits:
            cpus: '2'
            memory: 100M
          reservations:
            memory: 100M
      volumes:
      - type: bind
        source: <path-to-repo>/autogenerated_files/v21049_m1_g1_r2_my1_api1/volumes/sysbench_single
        target: /home/mysql/benchmarks/sysbench_single
      - type: bind
        source: <path-to-repo>/autogenerated_files/v21049_m1_g1_r2_my1_api1/volumes/dbt2_single
        target: /home/mysql/benchmarks/dbt2_single
      environment:
      - HOST_GROUP_ID=20
      - MYSQL_PASSWORD=Abc123?e
